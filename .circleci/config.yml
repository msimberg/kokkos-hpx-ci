version: 2
jobs:
  setup:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    steps:
      - run:
          name: Cloning Kokkos development branch
          command: |
            git clone https://github.com/msimberg/kokkos.git
            cd kokkos
            git checkout hpx-backend-task-distribution
      - run:
          name: Configure HPX runtime
          command: |
            printf '[hpx]\nos_threads=2' > hpx.ini
      - persist_to_workspace:
           root: /kokkos-hpx
           paths:
             - ./*
  build_and_test_blocking_0:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=0" \
                --with-devices=HPX \
                --with-hpx-options= \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test
  build_and_test_async_0:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=0" \
                --with-devices=HPX \
                --with-hpx-options=enable_async_dispatch \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test
  build_and_test_blocking_1:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=1" \
                --with-devices=HPX \
                --with-hpx-options= \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test
  build_and_test_async_1:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=1" \
                --with-devices=HPX \
                --with-hpx-options=enable_async_dispatch \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test
  build_and_test_blocking_2:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=2" \
                --with-devices=HPX \
                --with-hpx-options= \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test
  build_and_test_async_2:
    docker:
      - image: stellargroup/hpx:dev
    working_directory: /kokkos-hpx
    environment:
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig/
      HPX_INI: /kokkos-hpx/hpx.ini
    steps:
      - attach_workspace:
          at: /kokkos-hpx
      - run:
          # TODO: Add bc to image
          name: Installing bc for Makefiles
          command: |
            apt install -y bc
      - run:
          name: Building Kokkos with HPX backend (blocking)
          command: |
            mkdir build && cd build
            ../kokkos/generate_makefile.bash \
                --compiler=$CXX \
                --cxxstandard=c++17 \
                --cxxflags="-DKOKKOS_HPX_IMPLEMENTATION=2" \
                --with-devices=HPX \
                --with-hpx-options=enable_async_dispatch \
                --with-options=disable_deprecated_code,compiler_warnings \
                --debug
            make -j2 build-test
      - run:
          name: Running Kokkos tests (blocking)
          command: |
            cd build
            make test

workflows:
  version: 2
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * * "
          filters:
            branches:
              only:
                - master
    jobs:
      - setup
      - build_and_test_blocking_0:
          requires:
            - setup
      - build_and_test_async_0:
          requires:
            - setup
      - build_and_test_blocking_1:
          requires:
            - setup
      - build_and_test_async_1:
          requires:
            - setup
      - build_and_test_blocking_2:
          requires:
            - setup
      - build_and_test_async_2:
          requires:
            - setup

